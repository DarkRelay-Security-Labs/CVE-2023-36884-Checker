function Test-RegistryValue {
    param (
        [parameter(Mandatory = $true)][ValidateNotNullOrEmpty()][string]$Path,
        [parameter(Mandatory = $true)][ValidateNotNullOrEmpty()][string]$Value
    )
    try {
        $Values = Get-ItemProperty -Path $Path -ErrorAction Stop | select-object -ExpandProperty $Value -ErrorAction Stop 
        $True
         
    }
    catch {
        $False
    }
}

$key = "HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_BLOCK_CROSS_PROTOCOL_FILE_NAVIGATION"
$applications = @("Excel.exe", "Graph.exe", "MSAccess.exe", "MSPub.exe", "PowerPnt.exe", "Visio.exe", "WinProj.exe", "WinWord.exe", "Wordpad.exe")

$result = $True
foreach ($app in $applications) {
    $res = Test-RegistryValue -Value $app -Path $key
    if($res){
        Write-Output "DEBUG:OK, $app has CVE-2023-36884 mitigation enabled"
    }
    else
    {
        $result = $False
        Write-Output "DEBUG:KO, $app FEATURE_BLOCK_CROSS_PROTOCOL_FILE_NAVIGATION should be set to 1"
    }
}

if($result){
    Write-Output "META:hardening-CVE-2023-36884:OK"
}
else
{
    Write-Output "META:hardening-CVE-2023-36884:KO"
}

